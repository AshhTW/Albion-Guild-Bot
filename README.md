# 分錢仔v2 Discord Bot

- 一個為 Albion Online 公會設計的 Discord Bot 用來管理公會財務和出團loot結算,皆以圖片方式顯示輸出 十分檢而易懂 取代攏長又難懂的文字顯示.
- 此機器人模仿公會 "Journey Uncharted" 的分錢仔進行製作.
- 只花費約 3h 製作, 如有bug請開issue反應
- 如有不適當或更多需求製作請聯繫discord: ashaintyou

### 環境需求

- Node.js 18+
- npm

### 部署方式

- 建立 `.env` 並設定:
  - `DISCORD_TOKEN`
  - `DISCORD_CLIENT_ID`
  - `DISCORD_GUILD_ID`
- 註冊 Slash 指令: `node register-commands.js`
- 啟動 Bot: `npm start`

---

## 功能指令介紹

### `/account`

- 查詢自己或指定成員目前的銀幣數量.
- 參數: `user` (選填), 不填則查詢自己.

### `/balance`

- 管理員手動調整任意成員的銀幣 (加錢或扣錢).
- 需要 `管理員` 權限.
- 參數: `action` (`add`/`remove`), `user`, `amount` (> 0).

### `/give`

- 玩家之間互相轉帳銀幣.
- 參數: `user` (收款對象), `amount` (> 0).
- 限制: 不能轉給自己; 轉出者餘額不足會失敗.

### `/split`

- 用於 CTM 或團隊活動結算, 將一次活動的收入分給隊長與隊員.
- 需要 `管理員` 權限, 且僅允許在類別名稱為 `分錢仔` 的分類底下的頻道使用.
- 參數: `總收入`, `修裝費`, `稅率(%)`, `隊長`, `成員` (@mention 成員).
- 分錢算法詳見 "算法介紹".

### 暱稱格式建議 (關於 `(`)

- 建議暱稱使用 `遊戲ID(暱稱)` 格式, 例如: `AshhTW(艾許)`.
- Bot 會在圖片與訊息中顯示括號前的部分 (例如只顯示 `AshhTW`), 括號後面的內容僅作為備註.
- `silver_data.json` 中的 `name` 會同步為目前的完整暱稱 (包含括號後的文字), 方便對照實際成員身分.

---

## 算法介紹

### `/split` 分錢算法

1. **確認參與成員**:
   - 從你輸入的 `成員` 欄位裡讀出所有被 @ 的隊員, 排除隊長本人並去掉重複.
   - 計算這次分錢總共有幾個人參與 (隊長 + 所有隊員).

2. **先扣掉公會稅與修裝費**:
   - 依你輸入的稅率, 先從總收入中算出 "公會要收走的稅".
   - 再從總收入中扣掉 "公會稅" 與 "修裝費", 剩下的就是可以拿來分給大家的錢.

3. **平均分給所有人, 隊長多拿修裝費**:
   - 把 "可以分給大家的錢" 平均分成 "參與人數" 等份.
   - 每位成員 (包含隊長) 拿到一份平均分配的金額.
   - 隊長另外再多拿 "整筆修裝費", 等於修裝費完全由整隊一起分攤.

4. **更新帳本與公會財產**:
   - 把剛剛算出的金額加到隊長與每位隊員各自的帳戶中.
   - 這些錢視為從機器人帳戶 (公會資金) 支出, 同時從機器人帳戶扣掉這次實際發出去的總額.
   - 如果你在分錢前, 習慣先把本次活動總收入加到機器人帳戶, 那麼分完錢後, 機器人帳戶剩下的, 就可以視為這場活動留下來的 "公會稅 + 四捨五入造成的小餘額".

### 資料格式

所有銀幣資料儲存在專案根目錄的 `silver_data.json`:

- `silver`: 成員目前擁有的銀幣數量.
- `name`: 使用者名稱

---

## License

MIT 2025 AshhTW
